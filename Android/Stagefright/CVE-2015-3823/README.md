<?xml version="1.0" encoding="UTF-8"?><html xmlns="http://www.w3.org/1999/xhtml" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:fn="http://www.w3.org/2005/xpath-functions" xmlns:xdt="http://www.w3.org/2005/xpath-datatypes" xmlns:err="http://www.w3.org/2005/xqt-errors"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><title>Fundación Dr. Manuel Sadosky - Programa STIC Advisory</title><script language="javascript">
						function showFullCode(textareaId)
						{
								theTextArea = document.getElementById(textareaId);
								content = theTextArea.value.split(String.fromCharCode(10));
								height = (400 + content.length % 500) % 800;
								win = window.open("", "Window3", "width=800,height=" + height + ",scrollbars=yes");
								win.document.writeln("<pre>" + theTextArea.innerHTML + "</pre>");
								win.document.close();
								return false;
						 }
					</script></head><body><div id="content-title">Vulnerability in Android library while parsing while parsing Mastroska (MKV) video files</div>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <h3>1.
					Advisory Information</h3>
    <p>
      <strong>Title: </strong>Vulnerability in Android library while parsing while parsing Mastroska (MKV) video files<br/><strong>Advisory ID: </strong>CVE-2015-3823<br/><strong>Advisory URL: </strong><a target="_blank" href="http://www.fundacionsadosky.org.ar/publicaciones-2">http://www.fundacionsadosky.org.ar/publicaciones-2</a><br/><strong>Date published: </strong>2015-12-1<br/><strong>Date of last update: </strong>2015-12-01<br/><strong>Vendors contacted: </strong>Google<br/><strong>Release mode: </strong>Coordinated release<br/>
    </p>        
  
  
  <h3>2.
					Vulnerability Information</h3>
    <p>
      <strong>Class: </strong>Integer Overflow to Buffer Overflow [<a target="_blank" href="http://cwe.mitre.org/data/definitions/680.html">CWE-680</a>]<br/><strong>Impact: </strong>Data loss<br/><strong>Remotely Exploitable: </strong>Yes<br/><strong>Locally Exploitable: </strong>No<br/><strong>CVE Identifier: </strong><a target="_blank" href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=2015-3823">CVE-2015-3823</a><br/>
    </p>
  
  
<h3>3.
					Vulnerability Description</h3>
<p>
Stagefright is a media library running in Android devices used as a backend engine for playing various multimedia formats such as MP3, MKV, MP4, etc.
</p>
<p>
A vulnerability exists in the library that is triggered when procesing a malformed MKV video file. The bug can be used by a potential attacker to perform arbitrary operations on the victim device. 
</p>
<p>
In order to exploit the problem an attacker would need a victim to open an specially crafted MKV video file. This could be done via sending an MMS message to the device, tricking the user into browsing a site controlled by the attacker or sending it via to app installed in the victim's device such as an instant messaging app.
</p>
<p>
The problem was assigned as critical severity by the vendor (Google) and it affects around 93% of Android mobile devices around the world.
</p>

<h3>4.
					Vulnerable packages</h3>
<p>
<ul>
<li class="smbull3">Android Lollipop 5.1.1 without October security updates.</li>
</ul>
</p>


<h3>5.
					Vendor Information, Solutions and Workarounds</h3>
<p>
Vendor fixed issue in the Android Open Source Project (AOSP) repository on October 2015 and notified it's partners on September 10, 2015. The problem was independently found by Wish Wu of Trend Micro Inc but its severity was originally underestimated.
</p>


<h3>6.
					Credits</h3>
<p>
This vulnerability was discovered and researched by Joaquín Manuel Rinaudo. The publication of this advisory was coordinated by Programa Seguridad en TIC. 
</p>


<a id="td"></a><h3>7.
					Technical Description</h3>
<p>
In libstagefright, MatroskaExtractor.cpp is used to parse .MKV files. The extractor calls <a target="_blank" href="http://androidxref.com/5.1.1_r6/xref/frameworks/av/media/libstagefright/matroska/MatroskaExtractor.cpp#read">Matroska::read</a> to iterate over each frame and pass twice over a sequence of NAL fragments to collate them into a single large buffer.
</p>
<p>
The relevant portions of the code from Matroska:read() are shown below:
</p>
</p><textarea rows="28" cols="60" wrap="off" style="overflow:auto" id="code1">616    size_t dstSize = 0;
617    MediaBuffer *buffer = NULL;
618    uint8_t *dstPtr = NULL;
619
620    for (int32_t pass = 0; pass &lt; 2; ++pass) {
621        size_t srcOffset = 0;
622        size_t dstOffset = 0;
623        while (srcOffset + mNALSizeLen &lt;= srcSize) {
624            size_t NALsize;
625            switch (mNALSizeLen) {
626                case 1: NALsize = srcPtr[srcOffset]; break;
627                case 2: NALsize = U16_AT(srcPtr + srcOffset); break;
628                case 3: NALsize = U24_AT(srcPtr + srcOffset); break;
629                case 4: NALsize = U32_AT(srcPtr + srcOffset); break;
630                default:
631                    TRESPASS();
632            }
633
634            if (srcOffset + mNALSizeLen + NALsize &gt; srcSize) {
635                break;
636            }
637
638            if (pass == 1) {
639                memcpy(&amp;dstPtr[dstOffset], "\x00\x00\x00\x01", 4);
640
641                memcpy(&amp;dstPtr[dstOffset + 4],
642                       &amp;srcPtr[srcOffset + mNALSizeLen],
643                       NALsize);
644            }
645
646            dstOffset += 4;  // 0x00 00 00 01
647            dstOffset += NALsize;
648
649            srcOffset += mNALSizeLen + NALsize;
650        }
651
652        if (srcOffset &lt; srcSize) {
653            // There were trailing bytes or not enough data to complete
654            // a fragment.
655
656            frame-&gt;release();
657            frame = NULL;
658
659            return ERROR_MALFORMED;
660        }
661
662        if (pass == 0) {
663            dstSize = dstOffset;
664
665            buffer = new MediaBuffer(dstSize);
666
667            int64_t timeUs;
668            CHECK(frame-&gt;meta_data()-&gt;findInt64(kKeyTime, &amp;timeUs));
669            int32_t isSync;
670            CHECK(frame-&gt;meta_data()-&gt;findInt32(kKeyIsSyncFrame,
&amp;isSync));
671
672            buffer-&gt;meta_data()-&gt;setInt64(kKeyTime, timeUs);
673            buffer-&gt;meta_data()-&gt;setInt32(kKeyIsSyncFrame, isSync);
674
675            dstPtr = (uint8_t *)buffer-&gt;data();
676        }
677    }
678
679    frame-&gt;release();   
</textarea><a class="codeLink" href="#" onclick="return showFullCode('code1');" style="display: block;align:right;font-family:'arial',verdana,geneva,sans-serif;font-size:10px;color:#AF0000;" >[+ full code]</a><p>
<p>
In each frame of type AVC a sequence of NAL fragments is collated into a large buffer in which fragments are delimited by the "\x00\x00\x00\x01" 4-byte sequence. The for loop in line 620 passes twice per frame, on each pass the entire sequence of NAL fragments is processed within the while loop at line 623.
</p>
<p>
On the first pass the size required for a buffer is calculated by summing the size of each fragment plus 4 for the delimiter and storing it in the 'dstOffset' variable (line 647). A buffer of the calculated size is then allocted at line 665. On the second pass the contents of each NAL fragment are copied into the buffer at line 641.
</p>
<p>
The 'dstSize', 'dstOffset', 'srcOffset' and 'NALsize' variables are defined as unsigned 32-bit integers (size_t) and therefore arithmetic calculations that combine them will wrap around on overflow. On the other hand, the memcpy() call at 643 will use the length specified in the NAL fragment ('NALsize') as its third argument.
</p>
<p>
It is possible to construct a sequence of NAL fragments will force an arbitrary number of iterations of the while loop that will make the 'dstOffset' variable wrap around and allocate a smaller-than-needed buffer on the first pass. Then on the second pass, a trailing NAL fragment with a large NALsize will trigger heap corrupion on the memcpy() call. To accomplish this, the sequence of NALsizes in the fragments must be made to wrap around and pass the conditionals in lines 623 and 652.
</p>
<p>
For example, assuming a mNALSizeLen == 4 and an input buffer size (srcSize) of SZ, the following sequence of NAL fragments will overwrite the allocated buffer at the memcpy() call in the second pass.
</p>
</p><textarea rows="5" cols="60" wrap="off" style="overflow:auto" id="code2">|(SZ-8)|(SZ-8)| SZ-12 bytes| 0xFFFFFFFF - SZ + 9 |
|      |      |            |                     |
   4       4     SZ-12                4

</textarea><a class="codeLink" href="#" onclick="return showFullCode('code2');" style="display: block;align:right;font-family:'arial',verdana,geneva,sans-serif;font-size:10px;color:#AF0000;" >[+ full code]</a><p>

  
  <h3>8.
					Report Timeline</h3>
    <p>
          
      <ul><li class="smbull3"><strong>2015-08-15: </strong>
        Issue opened at Android issue tracker. Technical details of the vulnerabilities sent to the vendor.
        </li><li class="smbull3"><strong>2015-08-15: </strong>
        Programa STIC noted that the issue seemed previously reported and already disclosed by Trendmicro but that the analysis in their blogpost underestimated the exploitability of the bug
        </li><li class="smbull3"><strong>2015-08-17: </strong>
         Vendor confirmed the bug as a duplicate of the vulnerability reported by Trendmicro, internally tracked as AndroidID-21335999.
        </li><li class="smbull3"><strong>2015-08-17: </strong>
        Programa STIC noted that Trendmicro estimated the impact as merely an "infinite loop" (DoS) when it is in fact a remote code execution vulnerability.
        </li><li class="smbull3"><strong>2015-08-17: </strong>
        Vendor agreed with impact assessment, upgrades priority from Medium to Critical
        </li><li class="smbull3"><strong>2015-08-18: </strong>
        Vendor provided private patch for review.
        </li><li class="smbull3"><strong>2015-08-21: </strong>
        Programa STIC said the patch fixed the bug correctly and provided two CTS test cases.
        </li><li class="smbull3"><strong>2015-08-28: </strong>
        Programa STIC asked for the estimated release date of the fix and noted that Trendmicro had also changed their impact assessment in their blogpost.
        </li><li class="smbull3"><strong>2015-08-30: </strong>
         Vendor said that the fix will be rolling out as part of the Oct 2015 update for Nexus devices, at which time it will also land on AOSP and that it will also be notifying partners about the bug and fix in our September partner security bulletin. Vendor wondered about how Trendmicro found out about the revised impact rating and said they hadn't notified them of the new blogpost.
        </li><li class="smbull3"><strong>2015-08-30: </strong>
         Programa STIC said that it had commented on Twitter that Trendmicro's impact assessment was wrong. Asked if the Trendmicro reporters did not have access to the issue reported by Programa STIC anyway, since it was flagged as duplicate of theirs. Noted that waiting an additional month for the fix to come out seemed too much and asked if there was not going to be a Android security update in September 2015 or if there was but the fix for this vulnerability wont be included.
       </li><li class="smbull3"><strong>2015-08-30: </strong>
         Vendor merged Android issue 183986 into this issue. Possibly a 3rd indepedent report of the same vulnerability.
       </li><li class="smbull3"><strong>2015-09-03: </strong>
        CVE-2015-3823 assigned to the issue.
        </li><li class="smbull3"><strong>2015-09-17: </strong>
        Vendor said the fix is available to partners now, and should be available in the October Nexus update in early October.
        </li><li class="smbull3"><strong>2015-10-05: </strong>
        Nexus security bulletin - October 2015 published.
        </li><li class="smbull3"><strong>2015-10-07: </strong>
        Vendor released a patch in Android Open Source Project (AOSP) repository.
        </li><li class="smbull3"><strong>2015-12-1: </strong>
         Advisory was released. 
        </li></ul>
    </p>
  
  
  <h3>9.
					References</h3>
    <p/>
  
  
  <h3>10.
					About Fundación Dr. Manuel Sadosky</h3>
    <p>
      The Dr. Manuel Sadosky Foundation is a mixed (public / private) institution whose goal is to promote stronger and closer interaction between industry and the scientific-technological system in all aspects related to Information and Communications Technology (ICT). The Foundation was formally created by a Presidential Decree in 2009. Its Chairman is the Minister of Science, Technology, and Productive Innovation of Argentina; and the Vice-chairmen are the chairmen of the country’s most important ICT chambers: The Software and Computer Services Chamber (CESSI) and the Argentine Computing and Telecommunications Chamber (CICOMRA). For more information visit: <a href="#">http://www.fundacionsadosky.org.ar</a>
    </p>    
  
  
  <h3>11.
					Copyright Notice</h3>
    <p>
      The contents of this advisory are copyright (c) 2014 Fundación Sadosky and are licensed under a Creative Commons Attribution Non-Commercial Share-Alike 4.0 License: 
      <a target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">http://creativecommons.org/licenses/by-nc-sa/4.0/</a>
    </p>
  
  
  
  
 
</body></html>