
# >Vulnerabilidad en biblioteca de Android que procesa archivos de audio en formato MP3


## 1. Información del reporte

**Título:** >Vulnerabilidad en biblioteca de Android que procesa archivos de audio en formato MP3

**Reporte ID:** CVE-2015-6604

**Reporte URL:** [http://www.fundacionsadosky.org.ar/publicaciones/#seguridad-en-tic](http://www.fundacionsadosky.org.ar/publicaciones/#seguridad-en-tic)

**Fecha de publicación:** 2015-12-01

**Fecha de última actualización:** 2016-1-22

**Fabricantes contactados:** Google

**Modo de publicación:** Coordinado



## 2. Información de vulnerabilidades

**Clase:** Integer Overflow to Buffer Overflow [[http://cwe.mitre.org/data/definitions/680.html](http://cwe.mitre.org/data/definitions/680.html)]

**Impacto:** Ejecución de código

**Remotamente explotable:** Yes

**Localmente explotable:** No

**Identificador CVE:** [http://cve.mitre.org/cgi-bin/cvename.cgi?name=2015-6604](http://cve.mitre.org/cgi-bin/cvename.cgi?name=2015-6604)



## 3. Descripción de vulnerabilidad

Stagefright es una biblioteca que corre en dispositivos Android que es utilizada como motor multimedia al procesar formatos como MP3, MP4, MKV, etc. 

Existe una vulnerabilidad en la biblioteca que se manifiesta al procesar archivos de audio con formato MP3 que incluyan un encabezado de tipo ID3 malformado. El bug puede ser utilizado por un potencial atacante para ejecutar comandos de manera remota en un dispositivo vulnerable y obtener acceso a los datos alojados en él.

Para explotar el problema, un potencial atacante requeriría que la victima abra un archivo MP3 que incluya un encabezado tipo ID3 diseñado especialmente para el ataque. Esto podría lograrse ya sea enviando el archivo en un mensaje de texto, engañando a la víctima para que lo descargue de un sitio web controlado por el atacante o copiándolo desde alguna aplicación instalada en el dispositivo, por ejemplo alguna de mensajería instantánea.

 El problema fue catalogado como de severidad crítica por el fabricante (Google) y afecta aproximadamente al 93% de los dispositivos móviles Android de todo el mundo.


## 4. Paquetes vulnerables

* Dispositivos corriendo Android Lollipop 5.1.1 sin las actualizaciones de seguridad de Octubre.

## 5. Información y soluciones del fabricante

El fabricante solucionó el problema en el repositorio Android Open Source Project (AOSP) en Octubre del 2015 y notificó a sus asociados en Septiembre 10, 2015. El problema fue encontrado de forma independiente por Ian Beer de Project Zero y Joshua Drake de Zimperium.


## 6. Créditos

Las vulnerabilidades fueron descubiertas e investigadas por Joaquín Manuel Rinaudo. La publicación de este reporte fue coordinada por Programa Seguridad en TIC. 

## 7. Descripción técnica

En libstagefright, MP3Extractor procesa la metadata de tipo ID3 utilizando el método parseV2 en [http://androidxref.com/5.1.1_r6/xref/frameworks/av/media/libstagefright/id3/ID3.cpp#118](http://androidxref.com/5.1.1_r6/xref/frameworks/av/media/libstagefright/id3/ID3.cpp#118)
Tras encontrarse con un encabezado de tipo ID3 que especifica un "version_major" de 4 el siguiente código es alcanzado:

```
195  if (header.version_major == 4) {
196        void *copy = malloc(size);
197        memcpy(copy, mData, size);
198
199        bool success = removeUnsynchronizationV2_4(false /* iTunesHack */);
200        if (!success) {
201            memcpy(mData, copy, size);
202            mSize = size;
203
204            success = removeUnsynchronizationV2_4(true /* iTunesHack */);
205


```

Si la primera llamada a removeUnsynchronizationV2_4 falla, la segunda llamada (con  iTunesHack == true) utilizará directamente datos provistos por el usuario para determinar si el tamaño de datos provisto está dentro de los límites: 

```
326 bool ID3::removeUnsynchronizationV2_4(bool iTunesHack) {
327    size_t oldSize = mSize;
328
329    size_t offset = 0;
330    while (offset + 10 <= mSize) {
331        if (!memcmp(&mData[offset], "\0\0\0\0", 4)) {
332            break;
333        }
334
335        size_t dataSize;
336        if (iTunesHack) {
337            dataSize = U32_AT(&mData[offset + 4]);
338        } else if (!ParseSyncsafeInteger(&mData[offset + 4], &dataSize)) {
339            return false;
340        }
341
342        if (offset + dataSize + 10 > mSize) {
343            return false;
344        }


```

En la primera llamada, iTunesHack es falso por lo que la variable de dataSize se lee con el método [http://androidxref.com/5.1.1_r6/xref/frameworks/av/media/libstagefright/id3/ID3.cpp#ParseSyncsafeInteger](http://androidxref.com/5.1.1_r6/xref/frameworks/av/media/libstagefright/id3/ID3.cpp#ParseSyncsafeInteger) que fallará si el valor provisto es negativo. 

Sin embargo, en la segunda llamada (ITunesHack vale true) la variable dataSize será directamente cargada desde el buffer de entrada. Un entero suficientemente grande podría hacer que la suma en la linea 342 produzca un overflow y se pase dicha verificación de limites.

Luego, cuando la variable dataSize será utilizada en un loop para iterar sobre el buffer de entrada y se copiará datos por fuera del límite del array de salida como se ve abajo:

```
365            for (size_t i = 0; i + 1 < dataSize; ++i) {
366                if (mData[readOffset - 1] == 0xff
367                        && mData[readOffset] == 0x00) {
368                    ++readOffset;
369                    --mSize;
370                    --dataSize;
371                }
372                mData[writeOffset++] = mData[readOffset++];
373            }
374            // move the remaining data following this frame
375            memmove(&mData[writeOffset], &mData[readOffset], oldSize - readOffset);
376


```


## 8. Cronología del reporte

* **2015-08-18:** 
        Se enviaron detalles de las vulnerabilidades técnicas y prueba de concepto al fabricante.
        
* **2015-08-12:** 
        El fabricante marcó la vulnerabilidad como un duplicado de un issue previamente reportado por Project Zero y notó que estaba sujeto a un deadline de 90 días.
        
* **2015-08-12:** 
        El fabricante unió el issue 182510 con el reportado.
        
* **2015-08-12:** 
        El fabricante notificó que un arreglo para el bug ya había sido mergeado en los branches internos de su repositorio.
        
* **2015-10-09:** 
        El fabricante publicó un parche en el repositorio Android Open Source Project (AOSP).
        
* **2015-10-09:** 
        Programa STIC notificó al fabricante que el CVE asignado en el Bulletin de Octubre de Seguridad de Nexus era incorrecto y que el correcto era CVE-2015-6604.
         
* **2016-1-22:** 
        El reporte fue publicado.
        

## 9. Referencias



## 10. Acerca Fundación Dr. Manuel Sadosky

La Fundación Dr. Manuel Sadosky es una institución público privada cuyo objetivo es favorecer la articulación entre el sistema científico – tecnológico y la estructura productiva en todo lo referido a la temática de las Tecnologías de la Información y la Comunicación (TIC). Creada a través del Decreto Nro. 678/09 del Poder Ejecutivo Nacional, la Fundación es presidida por el ministro de Ciencia, Tecnología e Innovación Productiva. Sus vicepresidentes son los presidentes de las cámaras más importantes del sector TIC: CESSI (Cámara de Empresas de Software y Servicios Informáticos) y CICOMRA (Cámara de Informática y Comunicaciones de la República Argentina). Para más información visitar: [http://www.fundacionsadosky.org.ar](http://www.fundacionsadosky.org.ar)

## 11. Derechos de autor

El contenido de este reporte tiene copyright (c) 2014 Fundación Sadosky y se publica bajo la licencia Creative Commons Attribution Non-Commercial Share-Alike 4.0: [http://creativecommons.org/licenses/by-nc-sa/4.0/](http://creativecommons.org/licenses/by-nc-sa/4.0/)