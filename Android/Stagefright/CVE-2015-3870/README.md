
# Vulnerability in Android library while parsing a MP4 video files


## 1. Advisory Information

**Title:** Vulnerability in Android library while parsing a MP4 video files

**Advisory ID:** CVE-2015-3870

**Advisory URL:** [http://www.fundacionsadosky.org.ar/publicaciones-2](http://www.fundacionsadosky.org.ar/publicaciones-2)

**Date published:** 2015-12-1

**Date of last update:** 2015-12-01

**Vendors contacted:** Google

**Release mode:** Coordinated release



## 2. Vulnerability Information

**Class:** Heap-based Buffer Overflow [[http://cwe.mitre.org/data/definitions/122.html](http://cwe.mitre.org/data/definitions/122.html)]

**Impact:** Code execution

**Remotely Exploitable:** Yes

**Locally Exploitable:** No

**CVE Identifier:** [http://cve.mitre.org/cgi-bin/cvename.cgi?name=2015-3870](http://cve.mitre.org/cgi-bin/cvename.cgi?name=2015-3870)



## 3. Vulnerability Description

Stagefright is a media library running in Android devices used as a backend engine for playing various multimedia formats such as MP3, MKV, MP4, etc.

A vulnerability exists in the library that is triggered when procesing a malformed MP4 video file. The bug can be used by a potential attacker to perform arbitrary operations on the victim device. 

In order to exploit the problem an attacker would need a victim to open an specially crafted MP4 video file. This could be done via sending an MMS message to the device, tricking the user into browsing a site controlled by the attacker or sending it via to app installed in the victim's device such as an instant messaging app.

The problem was assigned as critical severity by the vendor (Google) and it affects around 93% of Android mobile devices around the world.


## 4. Vulnerable packages

* Android Lollipop 5.1.1 without October security updates.

## 5. Vendor Information, Solutions and Workarounds

  Vendor fixed issue in the Android Open Source Project (AOSP) repository on October 2015 and notified it's partners on September 10, 2015. 


## 6. Credits

This vulnerability was discovered and researched by Joaquín Manuel Rinaudo and Iván Arce. The publication of this advisory was coordinated by Programa Seguridad en TIC. 

## 7. Technical Description

While processing .mp4 media files, libstagefright uses a MPEG4Extrator to iterate over the different atoms calling 
[http://androidxref.com/5.1.1_r6/xref/frameworks/av/media/libstagefright/OggExtractor.cpp#parseFileMetaData](http://androidxref.com/5.1.1_r6/xref/frameworks/av/media/libstagefright/OggExtractor.cpp#parseFileMetaData) to parse elements based on the Four Character Code (fourCC) it encounters.

Upon encountering elements with FourCC codes of "avcC" or "hvcC" the extractor will allocate a buffer, store the entire chunk in an array, tag it with a key corresponding to its fourCC code and defer further processing. 

Parsing of those elements will be picked up by convertMetaDataToMessage in [http://androidxref.com/5.1.1_r6/xref/frameworks/av/media/libstagefright/Utils.cpp](http://androidxref.com/5.1.1_r6/xref/frameworks/av/media/libstagefright/Utils.cpp)
Starting in line 177 it parses a AVCDecoderConfiguration record and flattens an array of variable length elements into an allocated buffer of fixed size:

```
177    if (meta->findData(kKeyAVCC, &type, &data, &size)) {
178        // Parse the AVCDecoderConfigurationRecord
179
180        const uint8_t *ptr = (const uint8_t *)data;
181
182        CHECK(size >= 7);
183        CHECK_EQ((unsigned)ptr[0], 1u);  // configurationVersion == 1
184        uint8_t profile = ptr[1];
185        uint8_t level = ptr[3];
186
187        // There is decodable content out there that fails the following
188        // assertion, let's be lenient for now...
189        // CHECK((ptr[4] >> 2) == 0x3f);  // reserved
190
191        size_t lengthSize = 1 + (ptr[4] & 3);
192
193        // commented out check below as H264_QVGA_500_NO_AUDIO.3gp
194        // violates it...
195        // CHECK((ptr[5] >> 5) == 7);  // reserved
196
197        size_t numSeqParameterSets = ptr[5] & 31;
198
199        ptr += 6;
200        size -= 6;
201
202        sp<ABuffer> buffer = new ABuffer(1024);
203        buffer->setRange(0, 0);
204
205        for (size_t i = 0; i < numSeqParameterSets; ++i) {
206            CHECK(size >= 2);
207            size_t length = U16_AT(ptr);
208
209            ptr += 2;
210            size -= 2;
211
212            CHECK(size >= length);
213
214            memcpy(buffer->data() + buffer->size(), "\x00\x00\x00\x01", 4);
215            memcpy(buffer->data() + buffer->size() + 4, ptr, length);
216            buffer->setRange(0, buffer->size() + 4 + length);
217
218            ptr += length;
219            size -= length;
220        }


```

At line 202 a buffer of fixed size is allocated, the loop in line 205 iterates over an array of variable length elements. For each element, its length is obtained from the file as a 16bit unsigned integer and the corresponding data is copied into the allocated buffer at line 215.

The CHECK() performed in line 212 ensures that the specified length does not exceed the input buffer but it does not prevent overwriting of heap memory is the length of the provided data exceeds the size of the allocated buffer.

A malformed MP4 file with an AVCDecoderConfiguration record that includes an SPS record in which the sum of the sizes of data elements exceed the fixed size buffer will corrupt the heap. This can be done with a single element of 1020 bytes or with multiple smaller elements.  

In either case, the setRange() call in line 216 will fail when it attempts to set the range past the allocated buffer's size, terminating the process. At this point the heap has already been corrupted by the memcpy() operation in  line 215 but it is unclear whether this can be exploited for anything different than a crash. 

The same issue is found 2 more times in Utils.cpp when processing a Picture Parameter Sets (PPS) record starting at [https://android.googlesource.com/platform/frameworks/av/+/android-5.1.1_r13/media/libstagefright/Utils.cpp#235](https://android.googlesource.com/platform/frameworks/av/+/android-5.1.1_r13/media/libstagefright/Utils.cpp#235)  and in the processing array of NAL units in the HVCC record starting at line  [https://android.googlesource.com/platform/frameworks/av/+/android-5.1.1_r13/media/libstagefright/Utils.cpp#255](https://android.googlesource.com/platform/frameworks/av/+/android-5.1.1_r13/media/libstagefright/Utils.cpp#255)

## 8. Report Timeline

* **2015-08-05:** 
         Issue opened at Android issue tracker. Technical details of the vulnerabilities sent to the vendor.
        
* **2015-08-06:** 
         Vendor said it cant be reproduced because it is already fixed in internal branch. 
        
* **2015-08-06:** 
         Programa STIC asked confirmation that this is considered a security bug, asked if it will be assigned 1 or 3 CVEs and the estimated release date for the fix. 
        
* **2015-08-17:** 
        The vendor said its treating the bug as a high severity issue  and have assigned CVE-2015-3870. It was found and fixed internally (tracked as ANDROID-22771132) in July 2015. 
        
* **2015-08-17:** 
         Programa STIC noted that the same vulnerable pattern was present 3 times in Utils.cpp :
         Parsing of SPS and PPS records in AVCC and parsing of HVCC in HEVC
        
* **2015-08-25:** 
         Android issue 183762 has been merged into this issue. Duplicate report from Wang Tao of Baidu X-Team.        
        
* **2015-09-03:** 
         CVE-2015-3870 assigned to this issue.         
        
* **2015-10-05:** 
        Nexus security bulletin - October 2015 published.
        
* **2015-10-09:** 
        Vendor released a patch in Android Open Source Project (AOSP) repository.
        
* **2015-12-1:** 
         Advisory was released. 

## 9. References



## 10. About Fundación Dr. Manuel Sadosky

The Dr. Manuel Sadosky Foundation is a mixed (public / private) institution whose goal is to promote stronger and closer interaction between industry and the scientific-technological system in all aspects related to Information and Communications Technology (ICT). The Foundation was formally created by a Presidential Decree in 2009. Its Chairman is the Minister of Science, Technology, and Productive Innovation of Argentina; and the Vice-chairmen are the chairmen of the country’s most important ICT chambers: The Software and Computer Services Chamber (CESSI) and the Argentine Computing and Telecommunications Chamber (CICOMRA). For more information visit: [http://www.fundacionsadosky.org.ar](http://www.fundacionsadosky.org.ar)

## 11. Copyright Notice

The contents of this advisory are copyright (c) 2014 Fundación Sadosky and are licensed under a Creative Commons Attribution Non-Commercial Share-Alike 4.0 License: [http://creativecommons.org/licenses/by-nc-sa/4.0/](http://creativecommons.org/licenses/by-nc-sa/4.0/)