<?xml version="1.0" encoding="UTF-8"?><html xmlns="http://www.w3.org/1999/xhtml" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:fn="http://www.w3.org/2005/xpath-functions" xmlns:xdt="http://www.w3.org/2005/xpath-datatypes" xmlns:err="http://www.w3.org/2005/xqt-errors"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><title>Fundación Dr. Manuel Sadosky - Programa STIC Advisory</title><script language="javascript">
						function showFullCode(textareaId)
						{
								theTextArea = document.getElementById(textareaId);
								content = theTextArea.value.split(String.fromCharCode(10));
								height = (400 + content.length % 500) % 800;
								win = window.open("", "Window3", "width=800,height=" + height + ",scrollbars=yes");
								win.document.writeln("<pre>" + theTextArea.innerHTML + "</pre>");
								win.document.close();
								return false;
						 }
					</script></head><body><div id="content-title">Vulnerability in Android library while parsing while parsing DRM content</div>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <h3>1.
					Advisory Information</h3>
    <p>
      <strong>Title: </strong>Vulnerability in Android library while parsing while parsing DRM content<br/><strong>Advisory ID: </strong>CVE-2015-3873<br/><strong>Advisory URL: </strong><a target="_blank" href="http://www.fundacionsadosky.org.ar/publicaciones-2">http://www.fundacionsadosky.org.ar/publicaciones-2</a><br/><strong>Date published: </strong>2015-12-1<br/><strong>Date of last update: </strong>2015-12-01<br/><strong>Vendors contacted: </strong>Google<br/><strong>Release mode: </strong>Coordinated release<br/>
    </p>        
  
  
  <h3>2.
					Vulnerability Information</h3>
    <p>
      <strong>Class: </strong>Integer Overflow to Buffer Overflow [<a target="_blank" href="http://cwe.mitre.org/data/definitions/680.html">CWE-680</a>]<br/><strong>Impact: </strong>Data loss<br/><strong>Remotely Exploitable: </strong>Yes<br/><strong>Locally Exploitable: </strong>No<br/><strong>CVE Identifier: </strong><a target="_blank" href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=2015-3873">CVE-2015-3873</a><br/>
    </p>
  
  
<h3>3.
					Vulnerability Description</h3>
<p>
Stagefright is a media library running in Android devices used as a backend engine for playing various multimedia formats such as MP3, MKV, MP4, etc. The library allows content providers to enforce digital rights management (DRM) licensing restrictions and constrains on end user devices by providing an interface to interact with DRM services running on the mobile device. 
</p>
<p>
A vulnerability exists in the library that is triggered when procesing video files that use this kind of protections of intellectual property rights (DRM) in Android devices. The bug can be used by a potential attacker to perform arbitrary operations on the victim device. 
</p>
<p>
In order to exploit the problem an attacker would need a victim to open an specially crafted video file with protected content. This could be done via sending an MMS message to the device, tricking the user into browsing a site controlled by the attacker or sending it via to app installed in the victim's device such as an instant messaging app.
</p>
<p>
The problem was assigned as critical severity by the vendor (Google) and it affects around 93% of Android mobile devices around the world.
</p>

<h3>4.
					Vulnerable packages</h3>
<p>
<ul>
  <li class="smbull3">Android Lollipop 5.1.1 and prior without October 2015 security updates.</li>
</ul>
</p>


<h3>5.
					Vendor Information, Solutions and Workarounds</h3>
<p>
  Vendor fixed issue in the Android Open Source Project (AOSP) repository on October 2015 and notified it's partners on September 10, 2015. 
</p>


<h3>6.
					Credits</h3>
<p>
This vulnerability was discovered and researched by Joaquín Manuel Rinaudo. The publication of this advisory was coordinated by Programa Seguridad en TIC. 
</p>


<a id="td"></a><h3>7.
					Technical Description</h3>
<p>
In libstagefright processing of media content with Elementary Stream based DRM (a MIME type string that starts with "drm+es_based+") is done by <a target="_blank" href="http://androidxref.com/5.1.1_r6/xref/frameworks/av/media/libstagefright/MediaExtractor.cpp">MediaExtractor</a>.
</p>
<p>
First MediaExtractor will open the data source and try to detect its type by iteration over the registered sniffer methods in DataSource:
</p>

</p><textarea rows="20" cols="60" wrap="off" style="overflow:auto" id="code1">53 sp&lt;MediaExtractor&gt; MediaExtractor::Create(
54        const sp&lt;DataSource&gt; &amp;source, const char *mime) {
55    sp&lt;AMessage&gt; meta;
56
57    String8 tmp;
58    if (mime == NULL) {
59        float confidence;
60        if (!source-&gt;sniff(&amp;tmp, &amp;confidence, &amp;meta)) {
61            ALOGV("FAILED to autodetect media content.");
62
63            return NULL;
64        }
65
66        mime = tmp.string();
67        ALOGV("Autodetected media content as '%s' with confidence %.2f",
68             mime, confidence);
69    }
70

</textarea><a class="codeLink" href="#" onclick="return showFullCode('code1');" style="display: block;align:right;font-family:'arial',verdana,geneva,sans-serif;font-size:10px;color:#AF0000;" >[+ full code]</a><p>
<p>
For DRM-enabled content, this will end up calling SniffDRM() which will initialize a DRMClient to communicate with the DRMManagerService and create a DRMExtractor for processing the content.
</p>

</p><textarea rows="12" cols="60" wrap="off" style="overflow:auto" id="code2">75   if (!strncmp(mime, "drm+", 4)) {
76        const char *originalMime = strchr(mime+4, '+');
77        if (originalMime == NULL) {
78            // second + not found
79            return NULL;
80        }
81        ++originalMime;
82        if (!strncmp(mime, "drm+es_based+", 13)) {
83            // DRMExtractor sets container metadata kKeyIsDRM to 1
84            return new DRMExtractor(source, originalMime);

</textarea><a class="codeLink" href="#" onclick="return showFullCode('code2');" style="display: block;align:right;font-family:'arial',verdana,geneva,sans-serif;font-size:10px;color:#AF0000;" >[+ full code]</a><p>
<p>
In the case of video content (AVC) with stream-based DRM, during playback the read() method in DRMExtractor will call in the decrypt method from the corresponding DRM service and process its output as shown below: 
</p>


</p><textarea rows="28" cols="60" wrap="off" style="overflow:auto" id="code3">126 status_t DRMSource::read(MediaBuffer **buffer, const ReadOptions *options) {
127    Mutex::Autolock autoLock(mDRMLock);
128    status_t err;
129    if ((err = mOriginalMediaSource-&gt;read(buffer, options)) != OK) {
130        return err;
131    }
132
133    size_t len = (*buffer)-&gt;range_length();
134
135    char *src = (char *)(*buffer)-&gt;data() + (*buffer)-&gt;range_offset();
136
137    DrmBuffer encryptedDrmBuffer(src, len);
138    DrmBuffer decryptedDrmBuffer;
139    decryptedDrmBuffer.length = len;
140    decryptedDrmBuffer.data = new char[len];
141    DrmBuffer *pDecryptedDrmBuffer = &amp;decryptedDrmBuffer;
142
143    if ((err = mDrmManagerClient-&gt;decrypt(mDecryptHandle, mTrackId,
144            &amp;encryptedDrmBuffer, &amp;pDecryptedDrmBuffer)) != NO_ERROR) {
145
146        if (decryptedDrmBuffer.data) {
147            delete [] decryptedDrmBuffer.data;
148            decryptedDrmBuffer.data = NULL;
149        }
150
151        return err;
152    }
153    CHECK(pDecryptedDrmBuffer == &amp;decryptedDrmBuffer);
154
155    const char *mime;
156    CHECK(getFormat()-&gt;findCString(kKeyMIMEType, &amp;mime));
157
158    if (!strcasecmp(mime, MEDIA_MIMETYPE_VIDEO_AVC) &amp;&amp; !mWantsNALFragments) {
159        uint8_t *dstData = (uint8_t*)src;
160        size_t srcOffset = 0;
161        size_t dstOffset = 0;
162
163        len = decryptedDrmBuffer.length;
164        while (srcOffset &lt; len) {
165            CHECK(srcOffset + mNALLengthSize &lt;= len);
166            size_t nalLength = 0;
167            const uint8_t* data = (const uint8_t*)(&amp;decryptedDrmBuffer.data[srcOffset]);
168
169            switch (mNALLengthSize) {
170                case 1:
171                    nalLength = *data;
172                    break;
173                case 2:
174                    nalLength = U16_AT(data);
175                    break;
176                case 3:
177                    nalLength = ((size_t)data[0] &lt;&lt; 16) | U16_AT(&amp;data[1]);
178                    break;
179                case 4:
180                    nalLength = U32_AT(data);
181                    break;
182                default:
183                    CHECK(!"Should not be here.");
184                    break;
185            }
186
187            srcOffset += mNALLengthSize;
188
189            if (srcOffset + nalLength &gt; len) {
190                if (decryptedDrmBuffer.data) {
191                    delete [] decryptedDrmBuffer.data;
192                    decryptedDrmBuffer.data = NULL;
193                }
194
195                return ERROR_MALFORMED;
196            }
197
198            if (nalLength == 0) {
199                continue;
200            }
201
202            CHECK(dstOffset + 4 &lt;= (*buffer)-&gt;size());
203
204            dstData[dstOffset++] = 0;
205            dstData[dstOffset++] = 0;
206            dstData[dstOffset++] = 0;
207            dstData[dstOffset++] = 1;
208            memcpy(&amp;dstData[dstOffset], &amp;decryptedDrmBuffer.data[srcOffset], nalLength);
209            srcOffset += nalLength;
210            dstOffset += nalLength;
211        }
212
213        CHECK_EQ(srcOffset, len);
214        (*buffer)-&gt;set_range((*buffer)-&gt;range_offset(), dstOffset);
215
216    } else {
217        memcpy(src, decryptedDrmBuffer.data, decryptedDrmBuffer.length);
218        (*buffer)-&gt;set_range((*buffer)-&gt;range_offset(), decryptedDrmBuffer.length);
219    }
220
221    if (decryptedDrmBuffer.data) {
222        delete [] decryptedDrmBuffer.data;
223        decryptedDrmBuffer.data = NULL;
224    }
225
226    return OK;
227 } 

</textarea><a class="codeLink" href="#" onclick="return showFullCode('code3');" style="display: block;align:right;font-family:'arial',verdana,geneva,sans-serif;font-size:10px;color:#AF0000;" >[+ full code]</a><p>
<p>
Decrypted video frames that include NALfragments will be pre-processed within the while loop at line 164. The loop concatenates and copies into a single buffer all the fragments, delimiting them with the 4-byte sequence  "\x00\x00\x00\x01", similar to the read() method of the MatroskaExtractor in Matroska.cpp.
</p>

<p>
The 'srcOffset', 'dstOffset' and 'nalLength' variables, all defined as unsigned 32-bit integers (size_t) are used to index into the input and output buffers for the copy operations. 
</p>

<p>
At line 180 'nalLength' is loaded as an unsigned 32-bit value directly from the input buffer (which was previously decrypted by the DRM service). 
</p>

<p>
At line 189 the provided 'nalLength' value is used for pointer arithmetic calculations to ensure that it does not exceed 'len' bytes, the allocated size of both the input and output buffers. However, since the check is performed on the sum of two variables of type size_t, a sufficiently large value of 'nalLength' will make the sum overflow and wrap around causing the condition to evaluate as false thus continuing processing with a nalLength outside the bounds of the input and output buffers. Then at line 208 'nalLength' is passed as the size argument to memcpy(), which will end up overwritting heap memory.
</p>
<p>
Note that exploitation of this bug for remote code execution would be extremely hard to detect or filter even on the Android device itself, since the vulnerability is only triggered after sucessful decryption of potentially malicious video frames. On the other hand, it seems to be an ideal bug for precise targeting and to avoid or otherwise impair incident forensics. Leveraging the playback restrictions that could be enforced using standard Android DRM services, an attacker could target exploitaiton to specific devices or during a specified timespan.
</p>


  
  <h3>8.
					Report Timeline</h3>
    <p>
          
      <ul><li class="smbull3"><strong>2015-08-18: </strong>
        Technical details of the vulnerabilities sent to the vendor.
        </li><li class="smbull3"><strong>2015-08-19: </strong>
        The vendor marked the vulnerability as a duplicate of a previously reported issue (as AndroidID-23016072) and assured that the problem was already fixed in an internal branch.
        </li><li class="smbull3"><strong>2015-08-20: </strong>
        Programa STIC asked for the assigned CVE.
        </li><li class="smbull3"><strong>2015-08-21: </strong>
        The vendor informed that the bug was assigned CVE-2015-3873.
        </li><li class="smbull3"><strong>2015-10-05: </strong>
        Nexus security bulletin - October 2015 published.
        </li><li class="smbull3"><strong>2015-10-09: </strong>
        Vendor released a patch in Android Open Source Project (AOSP) repository.
        </li><li class="smbull3"><strong>2015-12-1: </strong>
         Advisory was released. 
        </li></ul>
    </p>
  
  
  <h3>9.
					References</h3>
    <p/>
  
  
  <h3>10.
					About Fundación Dr. Manuel Sadosky</h3>
    <p>
      The Dr. Manuel Sadosky Foundation is a mixed (public / private) institution whose goal is to promote stronger and closer interaction between industry and the scientific-technological system in all aspects related to Information and Communications Technology (ICT). The Foundation was formally created by a Presidential Decree in 2009. Its Chairman is the Minister of Science, Technology, and Productive Innovation of Argentina; and the Vice-chairmen are the chairmen of the country’s most important ICT chambers: The Software and Computer Services Chamber (CESSI) and the Argentine Computing and Telecommunications Chamber (CICOMRA). For more information visit: <a href="#">http://www.fundacionsadosky.org.ar</a>
    </p>    
  
  
  <h3>11.
					Copyright Notice</h3>
    <p>
      The contents of this advisory are copyright (c) 2014 Fundación Sadosky and are licensed under a Creative Commons Attribution Non-Commercial Share-Alike 4.0 License: 
      <a target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">http://creativecommons.org/licenses/by-nc-sa/4.0/</a>
    </p>
  
  
  
  
 
</body></html>